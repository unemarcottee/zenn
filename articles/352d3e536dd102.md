---
title: 'collation_connection ã®ã¯ãŸã‚‰ãã‚’ç¢ºèª(Collation Coercibility)'
emoji: 'ğŸ¬'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [mysql, collation]
published: true
---

## tl;dr

- `collation_connection` ã‚’æŒ‡å®šã—ã¦ã‚‚å®Ÿç”¨ä¸Šã‚ã¾ã‚Šæ„å‘³ãŒãªã„ã“ã¨ã«ã¤ã„ã¦ MySQL ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® â†“ ã‚’å‹•ä½œç¢ºèªã—ãŸ

https://dev.mysql.com/doc/refman/8.0/ja/server-system-variables.html#sysvar_collation_database

> æ¥ç¶šæ–‡å­—ã‚»ãƒƒãƒˆã®ç…§åˆé †åºã€‚collation_connection ã¯ã€ãƒªãƒ†ãƒ©ãƒ«æ–‡å­—åˆ—ã®æ¯”è¼ƒã«é‡è¦ã§ã™ã€‚ ã‚«ãƒ©ãƒ å€¤ã¨æ–‡å­—åˆ—ã‚’æ¯”è¼ƒã™ã‚‹å ´åˆã€collation_connection ã¯é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚

- ãƒªãƒ†ãƒ©ãƒ«ã¨ãƒªãƒ†ãƒ©ãƒ«ã‚’æ¯”è¼ƒã™ã‚‹ã¨ãã«ã€ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä½œç”¨ã™ã‚‹ãŒã€ãƒªãƒ†ãƒ©ãƒ«ã¨ã‚«ãƒ©ãƒ å€¤ã‚’æ¯”è¼ƒã™ã‚‹ã¨ãã¯å½±éŸ¿ã—ãªã„

## ä»•æ§˜ã¨æƒ³å®šã•ã‚Œã‚‹å‹•ä½œ

- `collation_connection` ã¯ãƒªãƒ†ãƒ©ãƒ«ã®ç…§åˆé †åºã‚’æ±ºã‚ã‚‹
- è¤‡æ•°ã®ã‚ªãƒšãƒ©ãƒ³ãƒ‰ãŒç•°ãªã‚‹ç…§åˆé †åºã‚’æŒã¤ã¨ã [Collation Coercibility](https://dev.mysql.com/doc/refman/8.0/en/charset-collation-coercibility.html) ã«ã‚ˆã£ã¦ã€ç…§åˆé †åºãŒæ±ºã¾ã‚‹
- Coercibility ãŒå°ã•ã„ã»ã†ã®ç…§åˆé †åºãŒå„ªå…ˆã•ã‚Œã€ã‚«ãƒ©ãƒ ã® Coercibility ã¯ 2 ã§ã€ãƒªãƒ†ãƒ©ãƒ«ã¯ 4 ãªã®ã§ã€`WHERE` å¥ã§ã‚«ãƒ©ãƒ ã«ä¿æŒã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã¨æ¤œç´¢ã—ãŸã„ãƒªãƒ†ãƒ©ãƒ«ã‚’æ¯”è¼ƒã™ã‚‹ã¨ã€ã‚«ãƒ©ãƒ ã®ç…§åˆé †åº(ã‚«ãƒ©ãƒ ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã©ã“ã§å®šç¾©ã•ã‚ŒãŸã‹ã«ã‚ˆã‚‰ãš)ã«ã‚ˆã£ã¦æ±ºã¾ã‚‹ã€‚
- ã®ã§ `collation_connection` ã§ã€çµæœãŒå¤‰ã‚ã‚‹ã“ã¨ã¯å®Ÿç”¨ä¸Šã¯ãªã„

ã¨ã„ã†ã®ã‚’çŸ¥è­˜ã¨ã—ã¦çŸ¥ã£ã¦ã„ãŸãŒã€å®Ÿéš›ã«å‹•ãã‚’ã¿ãŸã“ã¨ãŒãªã‹ã£ãŸã®ã§ã€è©¦ã—ã¦ã¿ãŸã€‚

å‹•ä½œã¨ã—ã¦ã¯ã€ä»¥ä¸‹ãŒæœŸå¾…ã•ã‚Œã‚‹

- ãƒªãƒ†ãƒ©ãƒ«ã©ã†ã—ã®æ¯”è¼ƒã‚’ã—ãŸã¨ã `collation_connecion` ã«ã‚ˆã£ã¦çµæœãŒç•°ãªã‚‹
- ãƒªãƒ†ãƒ©ãƒ«ã¨ã‚«ãƒ©ãƒ ã€ã‚«ãƒ©ãƒ ç›¸äº’ã®æ¯”è¼ƒã‚’ã—ãŸã¨ã `collation_connecion` ã«ã‚ˆã£ã¦çµæœã¯å¤‰ã‚ã‚‰ãªã„ã€‚

## æ¯”è¼ƒã«ä½¿ã†ç…§åˆé †åº

- MySQL 8.0.32 ã§ `utf8mb4_0900_as_ci` ã¨ `utf8mb4_general_ci` ã‚’æ¯”è¼ƒ
  - `SET NAMES` ã‚„ `SET PERSIST` ã«ã‚ˆã‚‹ç…§åˆé †åºã®æŒ‡å®šã¯ãªã„ç’°å¢ƒ
- utf8mb4_0900_as_ci ã§ã¯æ¬¡ã®ã‚ˆã†ã«åˆ¤å®šã•ã‚Œã‚‹
  - 'ã¯' ã¨ 'ã±' ãŒåŒã˜
  - 'ğŸ£' ã¨ 'ğŸº' ã¯é•ã†
  - æ‹—éŸ³ã‚’è­˜åˆ¥ã—ãªã„
- ã“ã‚Œã«å¯¾ã— utf8mb4_general_ci ã§ã¯
  - 'ã¯' ã¨ 'ã±' ãŒé•ã†
  - 'ğŸ£' ã¨ 'ğŸº' ã¯åŒã˜
  - æ‹—éŸ³ã‚’è­˜åˆ¥ã™ã‚‹

## ç¢ºèªã—ãŸã“ã¨

- 2 ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(dgen, d900)ã‚’ä½œæˆã—ã€ãã‚Œãã‚Œç…§åˆé †åºãŒç•°ãªã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨
  - ä¸¡æ–¹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åŒã˜ã‹ãŸã¡ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€ã‚«ãƒ©ãƒ ã«æ˜ç¤ºçš„ã«ç…§åˆé †åºã‚’æŒ‡å®šã—ãŸå ´åˆã¯ãã®ç…§åˆé †åºãŒã€ã‚«ãƒ©ãƒ ãŠã‚ˆã³ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç…§åˆé †åºã‚’æŒ‡å®šã—ãªã„å ´åˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç…§åˆé †åºãŒãã‚Œãã‚ŒæŒ‡å®šã•ã‚Œã‚‹
  - ã‚«ãƒ©ãƒ é–“ã®æ¯”è¼ƒãŒã‚«ãƒ©ãƒ ã®ç…§åˆé †åºã«ã‚ˆã£ã¦æ±ºã¾ã‚‹ã“ã¨
  - ã‚«ãƒ©ãƒ ã¨ãƒªãƒ†ãƒ©ãƒ«ã®æ¯”è¼ƒãŒã‚«ãƒ©ãƒ ã®ç…§åˆé †åºã«ã‚ˆã£ã¦æ±ºã¾ã‚Š `collation_connection` ã®å¤‰æ›´ã«ã‚ˆã£ã¦ç•°ãªã‚‰ãªã„ã“ã¨
- ãƒªãƒ†ãƒ©ãƒ«ã®æ¯”è¼ƒã‚’ã—ãŸã¨ã `collation_connection` ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€æ¯”è¼ƒçµæœãŒç•°ãªã‚‹ã“ã¨

### å‹•ä½œã®è¨˜éŒ²

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã€ã‚«ãƒ©ãƒ ã®ç…§åˆé †åºã®ç¢ºèª

```sh
mysql> create database dgen character set utf8mb4 collate utf8mb4_general_ci;
Query OK, 1 row affected (0.01 sec)

mysql> create table dgen.t (
    ->     c00 int not null auto_increment primary key,
    ->     c10 varchar(32) not null default '',
    ->     c11 varchar(32) not null default '',
    ->     c20 varchar(32) character set utf8mb4 not null default '' ,
    ->     c21 varchar(32) character set utf8mb4 not null default '' ,
    ->     c30 varchar(32) character set utf8mb4 collate utf8mb4_general_ci not null default '',
    ->     c31 varchar(32) character set utf8mb4 collate utf8mb4_general_ci not null default '');
Query OK, 0 rows affected (0.02 sec)

mysql> create database d900 character set utf8mb4;
Query OK, 1 row affected (0.01 sec)

mysql> create table d900.t (
    ->     c00 int not null auto_increment primary key,
    ->     c10 varchar(32) not null default '',
    ->     c11 varchar(32) not null default '',
    ->     c20 varchar(32) character set utf8mb4 not null default '' ,
    ->     c21 varchar(32) character set utf8mb4 not null default '' ,
    ->     c30 varchar(32) character set utf8mb4 collate utf8mb4_general_ci not null default '',
    ->     c31 varchar(32) character set utf8mb4 collate utf8mb4_general_ci not null default '');
Query OK, 0 rows affected (0.02 sec)
```

```sh
mysql> select schema_name as d, default_character_set_name as `char`, default_collation_name as `collate` from information_schema.schemata where schema_name like 'd___';
+------+---------+--------------------+
| d    | char    | collate            |
+------+---------+--------------------+
| dgen | utf8mb4 | utf8mb4_general_ci |
| d900 | utf8mb4 | utf8mb4_0900_ai_ci |
+------+---------+--------------------+
2 rows in set (0.00 sec)

mysql> select table_schema as d, table_name as `table`, table_collation as `collate` from information_schema.tables where table_schema like 'd___';
+------+-------+--------------------+
| d    | table | collate            |
+------+-------+--------------------+
| d900 | t     | utf8mb4_0900_ai_ci |
| dgen | t     | utf8mb4_general_ci |
+------+-------+--------------------+
2 rows in set (0.01 sec)

mysql> select table_schema as d, table_name as `table`, column_name as `column`, character_set_name as `char`, collation_name as `collate` from information_schema.columns where table_schema like 'd___' and data_type like '%char%';
+------+-------+--------+---------+--------------------+
| d    | table | column | char    | collate            |
+------+-------+--------+---------+--------------------+
| dgen | t     | c10    | utf8mb4 | utf8mb4_general_ci |
| dgen | t     | c11    | utf8mb4 | utf8mb4_general_ci |
| dgen | t     | c20    | utf8mb4 | utf8mb4_0900_ai_ci |
| dgen | t     | c21    | utf8mb4 | utf8mb4_0900_ai_ci |
| dgen | t     | c30    | utf8mb4 | utf8mb4_general_ci |
| dgen | t     | c31    | utf8mb4 | utf8mb4_general_ci |
| d900 | t     | c10    | utf8mb4 | utf8mb4_0900_ai_ci |
| d900 | t     | c11    | utf8mb4 | utf8mb4_0900_ai_ci |
| d900 | t     | c20    | utf8mb4 | utf8mb4_0900_ai_ci |
| d900 | t     | c21    | utf8mb4 | utf8mb4_0900_ai_ci |
| d900 | t     | c30    | utf8mb4 | utf8mb4_general_ci |
| d900 | t     | c31    | utf8mb4 | utf8mb4_general_ci |
+------+-------+--------+---------+--------------------+
12 rows in set (0.01 sec)
```

- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

```sh
mysql> insert into dgen.t (c10, c11, c20, c21, c30, c31) values ('ã¯ã¯','ã±ã±','ã¯ã¯','ã±ã±','ã¯ã¯','ã±ã±'), ('ğŸ£','ğŸº','ğŸ£','ğŸº','ğŸ£','ğŸº'), ('ã³ã‚‡ã†ã„ã‚“','ã³ ã‚ˆã†ã„ã‚“','ã³ã‚‡ã†ã„ã‚“','ã³ã‚ˆã†ã„ã‚“','ã³ã‚‡ã†ã„ã‚“','ã³ã‚ˆã†ã„ã‚“');
Query OK, 3 rows affected (0.01 sec)
Records: 3  Duplicates: 0  Warnings: 0

mysql> insert into d900.t (c10, c11, c20, c21, c30, c31) values ('ã¯ã¯','ã±ã±','
ã¯ã¯','ã±ã±','ã¯ã¯','ã±ã±'), ('ğŸ£','ğŸº','ğŸ£','ğŸº','ğŸ£','ğŸº'), ('ã³ã‚‡ã†ã„ã‚“','
ã‚ˆã†ã„ã‚“','ã³ã‚‡ã†ã„ã‚“','ã³ã‚ˆã†ã„ã‚“','ã³ã‚‡ã†ã„ã‚“','ã³ã‚ˆã†ã„ã‚“');
Query OK, 3 rows affected (0.01 sec)
Records: 3  Duplicates: 0  Warnings: 0
```

#### ã‚«ãƒ©ãƒ ãƒ‡ãƒ¼ã‚¿ã®æ¯”è¼ƒ

- ã‚«ãƒ©ãƒ åŒå£«ã®æ¯”è¼ƒã‚‚ã‚«ãƒ©ãƒ ã¨ãƒªãƒ†ãƒ©ãƒ«ã®æ¯”è¼ƒã‚‚ `collation_connection` ã«ã‚ˆã£ã¦å¤‰åŒ–ã—ãªã„
  - ã‚«ãƒ©ãƒ ã®ç…§åˆé †åºãŒ utf8mb4_0900_ai_ci ã ã¨'ã¯'ã¨'ã±'ã¯åŒã˜ã§'ğŸ£'ã¨'ğŸº'ã¯é•ã†

```sh
mysql> set collation_connection=utf8mb4_0900_ai_ci;select @@collation_connection;
Query OK, 0 rows affected (0.00 sec)

+------------------------+
| @@collation_connection |
+------------------------+
| utf8mb4_0900_ai_ci     |
+------------------------+
1 row in set (0.00 sec)

mysql> select c10 as `ã¯/ã±`, c20 = c21 as `utf8mb4_0900_ai_ci columns`, 'ã¯ã¯' = c21 as `utf8mb4_0900_ai_ci column/literal`from dgen.t where c10 = 'ã¯ã¯' AND (c20 = c21 or c21 = 'ã¯ã¯');
+---------+----------------------------+-----------------------------------+
| ã¯/ã±   | utf8mb4_0900_ai_ci columns | utf8mb4_0900_ai_ci column/literal |
+---------+----------------------------+-----------------------------------+
| ã¯ã¯    |                          1 |                                 1 |
+---------+----------------------------+-----------------------------------+
1 row in set (0.00 sec)

mysql> select c10 as `ã¯/ã±`, c30 = c31 as `utf8mb4_general_ci columns`, 'ã¯ã¯' = c31 as `utf8mb4_general_ci column/literal`from dgen.t where c10 = 'ã¯ã¯' AND (c30 = c31 or c31 = 'ã¯ã¯');
Empty set (0.00 sec)

mysql> select c10 as `ğŸ£/ğŸº`, c20 = c21 as `utf8mb4_0900_ai_ci columns`, 'ğŸ£' = c21 as `utf8mb4_0900_ai_ci column/literal` from dgen.t where c10 = 'ğŸ£' AND (c20 = c21 or c21 = 'ğŸ£');
Empty set, 1 warning (0.00 sec)

mysql> select c10 as `ğŸ£/ğŸº`, c30 = c31 as `utf8mb4_general_ci columns`, 'ğŸ£' = c31 as `utf8mb4_general_ci column/literal` from dgen.t where c10 = 'ğŸ£' AND (c30 = c31 or c31 = 'ğŸ£');
+------+----------------------------+-----------------------------------+
| ?/?  | utf8mb4_general_ci columns | utf8mb4_general_ci column/literal |
+------+----------------------------+-----------------------------------+
| ğŸ£     |                          1 |                                 1 |
+------+----------------------------+-----------------------------------+
1 row in set, 1 warning (0.00 sec)
```

#### ãƒªãƒ†ãƒ©ãƒ«ã®æ¯”è¼ƒ

- ãƒªãƒ†ãƒ©ãƒ«ã©ã†ã—ã®æ¯”è¼ƒã§ã¯ `collation_connection` ã«ã‚ˆã£ã¦çµæœãŒã‹ã‚ã‚‹
  - utf8mb4_0900_ai_ci ã ã¨'ã¯'ã¨'ã±'ã¯åŒã˜ã§'ğŸ£'ã¨'ğŸº'ã¯é•ã†

```sh
mysql> set collation_connection=utf8mb4_0900_ai_ci;select @@collation_connection;
Query OK, 0 rows affected (0.01 sec)

+------------------------+
| @@collation_connection |
+------------------------+
| utf8mb4_0900_ai_ci     |
+------------------------+
1 row in set (0.00 sec)

mysql> select 'ã¯ã¯' = 'ã±ã±' as papa, 'ğŸ£' = 'ğŸº' as beer, 'ã³ã‚‡ã†ã„ã‚“' = 'ã³ã‚ˆã†ã„ã‚“' as hospital;
+------+------+----------+
| papa | beer | hospital |
+------+------+----------+
|    1 |    0 |        1 |
+------+------+----------+
1 row in set (0.00 sec)

mysql> set collation_connection=utf8mb4_general_ci;select @@collation_connection;
Query OK, 0 rows affected (0.00 sec)

+------------------------+
| @@collation_connection |
+------------------------+
| utf8mb4_general_ci     |
+------------------------+
1 row in set (0.00 sec)

mysql> select 'ã¯ã¯' = 'ã±ã±' as papa, 'ğŸ£' = 'ğŸº' as beer, 'ã³ã‚‡ã†ã„ã‚“' = 'ã³ã‚ˆã†ã„ã‚“' as hospital;
+------+------+----------+
| papa | beer | hospital |
+------+------+----------+
|    0 |    1 |        0 |
+------+------+----------+
1 row in set (0.00 sec)
```

### è£œè¶³

- coercibility ã‚’[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://dev.mysql.com/doc/refman/8.0/en/charset-collation-coercibility.html)ã«ãªã„ã‚‚ã®ã‚‚å«ã‚ã¦æ±‚ã‚ãŸ

```sh
mysql> select coercibility(concat(c20 collate utf8mb4_general_ci,c21)), coercibility(concat(c10,c21)), coercibility(concat(c10, c11)), coercibility(user()), coercibility(concat('ğŸ£','ğŸº')), coercibility(now()),  coercibility(NULL) from dgen.t limit 1\G
*************************** 1. row ***************************
coercibility(concat(c20 collate utf8mb4_general_ci,c21)): 0
                           coercibility(concat(c10,c21)): 1
                          coercibility(concat(c10, c11)): 2
                                    coercibility(user()): 3
                           coercibility(concat('?','?')): 4
                                     coercibility(now()): 5
                                      coercibility(NULL): 6
1 row in set (0.01 sec)
```

## ãŠã‚ã‚Šã«

- collation_connection ã®è¨­å®šã‚’ç¢ºèªã§ããŸ
  - ã‚«ãƒ©ãƒ å€¤ã‚’ concat ã§çµåˆã—ãŸã¨ã—ã¦ã‚‚ coercibility ã¯ 2 ã®ã¾ã¾ãªã®ã§ã€ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå®Ÿç”¨ä¸Šä¾¿åˆ©ã«ãªã‚‹å±€é¢ã¯ãªã•ãã†
- ã‚«ãƒ©ãƒ å®šç¾©ã§ `character set` ã‚’æŒ‡å®šã™ã‚‹ã¨ã€Database ã® collation ã§ã¯ãªãã€æŒ‡å®šã—ãŸ character set ã® default ãŒã‚«ãƒ©ãƒ ã® collate ã«ãªã‚‹ã“ã¨ã«æ°—ä»˜ã„ãŸ
