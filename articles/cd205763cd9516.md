---
title: 'EB ã‹ã‚‰ ECS ã«ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’ç§»è¡Œã—ãŸã‚‰ã€RequestStore ãŒæƒ³å®šå¤–ã®å‹•ä½œã‚’ã—ãŸã®ã§èª¿æŸ»ã—ãŸ'
emoji: 'ğŸ‰'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['SQS', 'ElasticBeanstalk', 'ActiveElasticJob', 'Rails', 'Ruby']
published: true
---

# tl;dr

- RequestStore ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã§åˆ†é›¢ã•ã‚Œã‚‹
- ElasticBeanstalk ã® Worker ç’°å¢ƒã§ã¯ SQS ã‚­ãƒ¥ãƒ¼ã¯ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ çµ„ã¿ã§å‡¦ç†ã•ã‚Œã‚‹
- ã‚¸ãƒ§ãƒ–ãƒ¯ãƒ¼ã‚«ãƒ¼ã§ã¯ã€ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®å–ã‚Šæ‰±ã„ã«æ³¨æ„ã™ã‚‹

# ãŠããŸã“ã¨

- ElasticBeanstalk(EB) ã§èµ·å‹•ã—ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ ElasticContainerService(ECS) ã«ç§»è¡Œã—ãŸ
  - EB ã® Worker ç’°å¢ƒã§èµ·å‹•ã—ã¦ã„ãŸãƒ¯ãƒ¼ã‚«ãƒ¼ã§ã¯ Active Job ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ ã¨ã—ã¦ active-elastic-job ã‚’åˆ©ç”¨
  - ECS ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ã§ã¯ Active Job ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ ã¨ã—ã¦ aws-sdk-rails ã‚’åˆ©ç”¨
- ECS ã§ worker ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ãŸã‚‰ `RequestStore` ã«ä¿æŒã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®æ··ç·šãŒèµ·ãã¯ã˜ã‚ãŸ
- ãƒ­ãƒ¼ã‚«ãƒ«ã® docker ç’°å¢ƒã§ã‚‚èµ·ãã¦ã‚‹ã£ã½ã„
- EB ã®ç’°å¢ƒã§ã¯èµ·ãã¦ãªã‹ã£ãŸ
  - ã‚¨ãƒ©ãƒ¼ã®æ¤œçŸ¥ã®ä»•çµ„ã¿ã«ã‚‚ã²ã£ã‹ã‹ã£ã¦ãªã„ã—ã€ãƒ‡ãƒ¼ã‚¿é¢ã§ã‚‚ç•°å¸¸ãŒãªã‹ã£ãŸ

# ãƒ‡ãƒ¼ã‚¿æ··ç·šã«æ°—ä»˜ãã¾ã§

- ã‚³ãƒ³ãƒ†ãƒŠã§å®Ÿè¡Œã•ã‚Œã‚‹ Ralis ã®ãƒ­ã‚°ã‚’ç›®è¦–ã§è¿½ã†ã“ã¨ã«ãªã£ãŸ
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã—ãŸã‚³ãƒ³ãƒ†ãƒŠã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¸ãƒ§ãƒ–ã‚’æ™‚ç³»åˆ—ã§æŠŠæ¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Š Athena ã§ã‚‚ã‚¯ã‚¨ãƒªã—ãã‚Œãªã‹ã£ãŸ
  - ã‚³ãƒ³ãƒ†ãƒŠ ID ãŒãƒ­ã‚®ãƒ³ã‚°ã•ã‚Œã‚‹ã®ã§ã€åŒã˜ã‚³ãƒ³ãƒ†ãƒŠ(ECS ã‚¿ã‚¹ã‚¯)ãŒå®Ÿè¡Œã—ãŸå‡¦ç†ã‚’ãŠã„ã‹ã‘ãŸ
- â†’ `RequestStore` ã«ä¿æŒã—ãŸå†…å®¹ãŒã‚¸ãƒ§ãƒ–é–“ã§æ··ç·šã—ã¦ã„ã‚‹ã¨ã‚ãŸã‚Šã‚’ã¤ã‘ãŸ

# RequestStore

## Gem ãŒè§£æ±ºã™ã‚‹ã“ã¨

- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãªå¤‰æ•°ã®ä¿æŒ
  - å‚è€ƒï¼š[ãƒªã‚¯ã‚¨ã‚¹ãƒˆå˜ä½ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªå‚ç…§ã‚’æŒãŸã›ã¦ Audit ãƒ­ã‚°ã‚’ã‚¹ãƒƒã‚­ãƒªå®Ÿè£…ã—ãŸã„](https://qiita.com/ainame/items/823b396d560d82194d48)
  - å‚è€ƒï¼š[RequestStore ã®ä½¿ã„æ–¹ ã¾ã¨ã‚](https://nekorails.hatenablog.com/entry/2018/10/19/202853)

## Gem ã®å‹•ä½œ

- ä¸Šæ²å‚è€ƒã‚µã‚¤ãƒˆã«ã‚‚ã‚ã‚‹ãŒ `RequestStore` ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã¾ãŸã„ã§å…±æœ‰ãŒãŠã“ã‚‰ãªã„ã‚ˆã†ã‚¯ãƒªã‚¢å‡¦ç†ãŒã‚ã‚‹

https://github.com/steveklabnik/request_store/blob/e803059c0d5f328b4eddc8161a074ae85fb049b7/lib/request_store/middleware.rb#L16-L24

- ä¸Šè¨˜ãŒç™ºå‹•ã™ã‚‹ã®ã¯ `call` ã•ã‚ŒãŸã¨ãã ã‘
  - é€†ã«è¨€ãˆã° `call` ã‚’é€šã‚‰ãªã„ãƒ‘ã‚¹ã§ `RequestStore.store` ã«èª­ã¿æ›¸ãã‚’ã—ã¦ã‚¹ãƒ¬ãƒƒãƒ‰ã®ä½¿ã„å›ã—ãŒãŠããŸå ´åˆã€å¤‰æ•°ã®æ··åŒãŒèµ·ãã‚‹ã€ã¨æƒ³å®šã§ãã‚‹ã€‚
- `call` ãŒã‹ã‹ã‚‹ã®ã¯ `ActionDispatch` ã§ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒèµ·ããŸã¨ãã€‚
  - å‚è€ƒï¼š[ActionDispatch ã£ã¦ãªã‚“ã ã‚ã†ï¼Ÿ - åºƒå³¶ãƒ»å²¡å±± Ruby äº¤æµä¼š 01](https://blog.eiel.info/blog/2014/03/30/action-dispatch/)

https://github.com/steveklabnik/request_store/blob/e803059c0d5f328b4eddc8161a074ae85fb049b7/lib/request_store/railtie.rb#L4-L8

ä¾‹ãˆã° `rails console` ã‚’ã™ã‚‹ã“ã¨ã§ã‚‚ `RequestStore::Middleware#initialize` ã®å®Ÿè¡Œã¯è¦³æ¸¬ã§ãã‚‹ãŒã€ä»–æ–¹ã§ `RequestStore::Middleware#call` ã®å®Ÿè¡Œã¯è¦³æ¸¬ã§ããªã„ã€‚

# ElasticBeanstalk ã® Worker ç’°å¢ƒã§ã®å‹•ä½œ

çµè«–ã¨ã—ã¦ Worker ç’°å¢ƒã§ã¯ã€SQS ã«ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ http ã® POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦ Rails ã«é€ã‚‰ã‚Œã‚‹ã€‚ã“ã®ãŸã‚ RequestStore çµ„ã¿è¾¼ã¿ã® clear ãŒç™ºå‹•ã™ã‚‹

- [Elastic Beanstalk worker environments](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html)

> Elastic Beanstalk worker environments simplify this process by managing the Amazon SQS queue and running a daemon process on each instance that reads from the queue for you. When the daemon pulls an item from the queue, it sends an HTTP POST request locally to http://localhost/ on port 80 with the contents of the queue message in the body. All that your application needs to do is perform the long-running task in response to the POST. You can configure the daemon to post to a different path, use a MIME type other than application/JSON, connect to an existing queue, or customize connections (maximum concurrent requests), timeouts, and retries.

## [Procfile]ãŒãªã„çŠ¶æ³ã§ã®å‹•ä½œç¢ºèª

- Procfile ã‚’é…ç½®ã—ã¦ã„ãªã‹ã£ãŸã®ã§ ElasticBeanstalk ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§å‹•ä½œã—ã¦ã„ã‚‹
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒç¢ºèªã§ããªã‹ã£ãŸã®ã§å‹•ä½œç’°å¢ƒã«ã¦ç¢ºèªã—ãŸ

### èµ·å‹•ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®ç¢ºèª

:::details systemctl ã§èµ·å‹•ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒªã‚¹ãƒˆã‹ã‚‰ web.service ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹

```sh
[ec2-user@ip-172-31-0-0 ~]$ systemctl list-unit-files -t service | grep enabled
# ... snip ...
sqsd.service                                  enabled
# ... snip ...
web.service                                   enabled
# ... snip ...
```

:::

### ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ­ã‚°ã®ç¢ºèª

:::details web.service ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ­ã‚°ã‹ã‚‰ puma ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ç¢ºèªã§ãã‚‹

```sh
[ec2-user@ip-172-31-0-0 ~]$ journalctl -u web
-- Logs begin at æœˆ 2023-10-16 22:30:54 UTC, end at *** --
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal systemd[1]: Starting This is web daemon...
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal systemd[1]: Started This is web daemon.
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal web[8849]: [8849] Puma starting in cluster mode...
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal web[8849]: [8849] * Puma version: 5.6.2 (ruby 2.7.5-p203) ("Birdie's Version")
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal web[8849]: [8849] *  Min threads: 8
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal web[8849]: [8849] *  Max threads: 32
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal web[8849]: [8849] *  Environment: production
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal web[8849]: [8849] *   Master PID: 8849
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal web[8849]: [8849] *      Workers: 4
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal web[8849]: [8849] *     Restarts: (âœ”) hot (âœ”) phased
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal web[8849]: [8849] * Listening on unix:///var/run/puma/my_app.sock
10æœˆ 16 22:36:54 ip-172-31-0-0.ap-northeast-1.compute.internal web[8849]: [8849] Use Ctrl-C to stop
[ec2-user@ip-172-31-0-0 ~]$ journalctl -u nginx
-- Logs begin at æœˆ 2023-10-16 22:30:54 UTC, end at *** --
10æœˆ 16 22:36:55 ip-172-31-0-0.ap-northeast-1.compute.internal systemd[1]: Starting The nginx HTTP and reverse proxy server...
10æœˆ 16 22:36:55 ip-172-31-0-0.ap-northeast-1.compute.internal nginx[8914]: nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
10æœˆ 16 22:36:55 ip-172-31-0-0.ap-northeast-1.compute.internal nginx[8914]: nginx: configuration file /etc/nginx/nginx.conf test is successful
10æœˆ 16 22:36:55 ip-172-31-0-0.ap-northeast-1.compute.internal systemd[1]: Started The nginx HTTP and reverse proxy server.
[ec2-user@ip-172-31-0-0 ~]$ journalctl -u sqsd
-- Logs begin at æœˆ 2023-10-16 22:30:54 UTC, end at *** --
10æœˆ 16 22:36:55 ip-172-31-0-0.ap-northeast-1.compute.internal systemd[1]: Starting This is sqsd daemon...
10æœˆ 16 22:36:57 ip-172-31-0-0.ap-northeast-1.compute.internal sqsd[8931]: Version 2 of the Ruby SDK will enter maintenance mode as of November 20, 2020. To continue receiving ser
10æœˆ 16 22:37:10 ip-172-31-0-0.ap-northeast-1.compute.internal sqsd[8931]: daemon is running with pid 9006...
10æœˆ 16 22:37:10 ip-172-31-0-0.ap-northeast-1.compute.internal systemd[1]: Started This is sqsd daemon.

```

:::

- socket ã‚’ listen ã—ã¦ã„ã‚‹ã®ã§ nginx ã®è¨­å®šã‚‚ç¢ºèªã—ãŸ

### Web ã®ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã®ç¢ºèª

:::details systemd ã§ã®è¨­å®šã‚’ç¢ºèª

```sh
[ec2-user@ip-172-31-0-0 ~]$ cat /etc/systemd/system/web.service
[Unit]
Description=This is web daemon
PartOf=eb-app.target

[Service]
User=webapp
Type=simple

ExecStart=/bin/sh -c "puma -C /opt/elasticbeanstalk/config/private/pumaconf.rb"

ExecStartPost=/bin/sh -c "systemctl show -p MainPID web.service | cut -d= -f2 > /var/pids/web.pid"
ExecStopPost=/bin/sh -c "rm -f /var/pids/web.pid"
ExecStopPost=/bin/sh -c ""
Restart=always

EnvironmentFile=/opt/elasticbeanstalk/deployment/env

StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=web
WorkingDirectory=/var/app/current/

[Install]
WantedBy=multi-user.target
```

:::

### nginx ã®è¨­å®šã®ç¢ºèª

:::details nginx.conf ã¨ãã“ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª

- nginx.conf

```sh
[ec2-user@ip-172-31-0-0 ~]$ cat /etc/nginx/nginx.conf
#Elastic Beanstalk Nginx Configuration File

user nginx;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;
worker_processes auto;
worker_rlimit_nofile 200000;

events {
worker_connections 1024;
}

http {
include /etc/nginx/mime.types;
default_type application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    include       conf.d/*.conf;

    map $http_upgrade $connection_upgrade {
        default     "upgrade";
    }

    server {
        listen        80 default_server;
        access_log    /var/log/nginx/access.log main;

        client_header_timeout 60;
        client_body_timeout   60;
        keepalive_timeout     60;
        gzip                  off;
        gzip_comp_level       4;
        gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;

        # Include the Elastic Beanstalk generated locations
        include conf.d/elasticbeanstalk/*.conf;
    }

}
```

- conf.d é…ä¸‹ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ—æŒ™ã¨ç¢ºèª

```sh
[ec2-user@ip-172-31-0-0 ~]$ ls -r /etc/nginx/conf.d/*.conf;
/etc/nginx/conf.d/healthd_logformat.conf /etc/nginx/conf.d/elasticbeanstalk-nginx-ruby-upstream.conf /etc/nginx/conf.d/custom.conf
[ec2-user@ip-172-31-0-0 ~]$ cat /etc/nginx/conf.d/healthd_logformat.conf
log_format healthd '$msec"$uri"'
'$status"$request_time"$upstream_response_time"'
                    '$http_x_forwarded_for';
[ec2-user@ip-172-31-0-0 ~]$ cat /etc/nginx/conf.d/elasticbeanstalk-nginx-ruby-upstream.conf
upstream my_app {
server unix:///var/run/puma/my_app.sock;
[ec2-user@ip-172-31-0-0 ~]$ cat /etc/nginx/conf.d/custom.conf
# ãƒ¦ãƒ¼ã‚¶å®šç¾©ã®ãŸã‚å‰²æ„›
```

- conf.d/elasticbeanstalk é…ä¸‹ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ—æŒ™ã¨ç¢ºèª

```sh
[ec2-user@ip-172-31-0-0 ~]$ ls -r /etc/nginx/conf.d/elasticbeanstalk/*.conf
/etc/nginx/conf.d/elasticbeanstalk/webapp.conf /etc/nginx/conf.d/elasticbeanstalk/healthd.conf
[ec2-user@ip-172-31-0-0 ~]$ cat /etc/nginx/conf.d/elasticbeanstalk/webapp.conf
server*name * localhost; # need to listen to localhost for worker tier

location / {
root /var/app/current/public;
try_files $uri @proxy;
}

location @proxy {
proxy_pass http://my_app; # match the name of upstream directive which is defined above
proxy_set_header Host $host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

location /assets {
alias /var/app/current/public/assets;
gzip_static on;
gzip on;
expires max;
add_header Cache-Control public;
}

location /public {
alias /var/app/current/public;
gzip_static on;
gzip on;
expires max;
add_header Cache-Control public;
}
[ec2-user@ip-172-31-0-0 ~]$ cat /etc/nginx/conf.d/elasticbeanstalk/healthd.conf
if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})T(\d{2})") {
set $year $1;
set $month $2;
set $day $3;
set $hour $4;
}

access_log /var/log/nginx/healthd/application.log.$year-$month-$day-$hour healthd;
```

:::

## ActiveElasticJob

- `SqsMessageConsumer` ã¯ POST é€ä¿¡ã•ã‚Œã¦ããŸ request ã‚’æ¨ªå–ã‚Šã—ã¦å‡¦ç†ã™ã‚‹

https://github.com/active-elastic-job/active-elastic-job/blob/092a8102cd38cffd7203d408fa03998cdff9dc03/lib/active_elastic_job/rack/sqs_message_consumer.rb#L5-L8

- `SqsMessageConsumer` è‡ªä½“ã¯ Railtie ã«ã‚ˆã£ã¦ middleware ã«ç™»éŒ²ã•ã‚Œã‚‹

https://github.com/active-elastic-job/active-elastic-job/blob/092a8102cd38cffd7203d408fa03998cdff9dc03/lib/active_elastic_job/railtie.rb#L15-L22

```sh
$ bundle exec rake middleware
use ActionDispatch::HostAuthorization
use Rack::Sendfile
# ... snip ...
use ActiveElasticJob::Rack::SqsMessageConsumer
# ... snip ...
run {RailsApplication}::Application.routes
```

# ECS ã§ã®å‹•ä½œ

## è¨­å®šçŠ¶æ³

- ã‚­ãƒ¥ãƒ¼ã®å‡¦ç†ã¨ã—ã¦ `aws-sdk-rails` ã‚’åˆ©ç”¨

```ruby
config.active_job.queue_adapter = :amazon_sqs
```

- èµ·å‹•ã‚³ãƒãƒ³ãƒ‰

```sh
bundle exec aws_sqs_active_job --queue {ã‚­ãƒ¥ãƒ¼å}
```

## amazon_sqs ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®å‹•ä½œ

README ã®è¨˜è¿°([Running workers - polling for jobs](https://github.com/aws/aws-sdk-rails#running-workers---polling-for-jobs))ã®ã¨ãŠã‚Šã€ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’ã—ã¦ã€ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãŒç›´æ¥ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹æ§‹æˆã¨ãªã£ã¦ã„ã‚‹ã€‚
å¾“ã£ã¦ `ActiveDispatch::Request` ãŒä»‹åœ¨ã—ãªã„ã€‚

- bin/aws_sqs_active_job ã¯ Poller ã‚’èµ·å‹•ã™ã‚‹

https://github.com/aws/aws-sdk-rails/blob/6f891009d91faa0582c60ea87c4bf94ead0b8adb/bin/aws_sqs_active_job#L4-L6

- Poller ã®ã‚¤ãƒ‹ã‚·ãƒ£ãƒ©ã‚¤ã‚ºã¨å®Ÿè¡Œ

https://github.com/aws/aws-sdk-rails/blob/6f891009d91faa0582c60ea87c4bf94ead0b8adb/lib/aws/rails/sqs_active_job/poller.rb#L14-L55

https://github.com/aws/aws-sdk-rails/blob/6f891009d91faa0582c60ea87c4bf94ead0b8adb/lib/aws/rails/sqs_active_job/poller.rb#L63-L94

- Executer ã®å®Ÿè¡Œ

https://github.com/aws/aws-sdk-rails/blob/6f891009d91faa0582c60ea87c4bf94ead0b8adb/lib/aws/rails/sqs_active_job/executor.rb#L24-L40

- JobRunner ã®å®Ÿè¡Œ

https://github.com/aws/aws-sdk-rails/blob/6f891009d91faa0582c60ea87c4bf94ead0b8adb/lib/aws/rails/sqs_active_job/job_runner.rb#L9-L17

### ä½™è«‡

- amazon_sqs ã‚‚ active_elastic_job ã®ã‚ˆã†ã« HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ä»•çµ„ã¿ã‚’ã‚‚ã£ã¦ã„ã‚‹
  - [Elastic Beanstalk workers: processing activejobs using worker environments](https://github.com/aws/aws-sdk-rails/tree/6f891009d91faa0582c60ea87c4bf94ead0b8adb#elastic-beanstalk-workers-processing-activejobs-using-worker-environments)

https://github.com/aws/aws-sdk-rails/blob/6f891009d91faa0582c60ea87c4bf94ead0b8adb/lib/aws/rails/railtie.rb#L77-L88

https://github.com/aws/aws-sdk-rails/blob/6f891009d91faa0582c60ea87c4bf94ead0b8adb/lib/aws/rails/middleware/ebs_sqs_active_job_middleware.rb#L17-L33

# ã¾ã¨ã‚

- `RequestStore` ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•
  - `Thread.current` ã‚’ä½¿ã†
- `RequestStore` ã¯ HTTP ãƒ™ãƒ¼ã‚¹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆã«ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã§ã€å¤‰æ•°ã®å…±æœ‰ãŒèµ·ããªã„ä»•çµ„ã¿ã‚’æŒã¤
- `ElasticBeanstalk` ã® Worker ç’°å¢ƒã§ã¯ SQS ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ã«é€ä¿¡ã•ã‚Œã‚‹
  - `active_elastic_job` ã® gem ã¯ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¨ªå–ã‚Šã—ã¦ job å®Ÿè¡Œã™ã‚‹
- `aws-sdk-rails` ã® `amazon_sqs` ã‚¸ãƒ§ãƒ–ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¯ã€SQS ã‚­ãƒ¥ãƒ¼ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦è‡ªå‰ã§ã‚¸ãƒ§ãƒ–ã‚’èµ·å‹•ã™ã‚‹
- Gem ã‚’å¤‰æ›´ã—ãŸã¨ãã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã®å¤‰æ›´ãŒãªã„ã‹è¦ç¢ºèª
  - åŠ¹æœçš„ãªãƒ†ã‚¹ãƒˆè¨­è¨ˆã‚‚å¤§äº‹
